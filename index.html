<!-- ... same head and body as before ... -->
<script>
    // ... (keep all variables, objects, event listeners the same until gameLoop) ...

    function updateBullets() {
        const slow = player.timeDistort > 0 ? 0.5 : 1;
        for (let i = bullets.length - 1; i >= 0; i--) {
            const b = bullets[i];
            // Cap trail length strictly
            b.trail.push({x: b.x, y: b.y});
            if (b.trail.length > 6) b.trail.shift();

            b.x += b.vx * slow;
            b.y += b.vy * slow;

            // Hard kill very old/long-living bullets
            if (b.x < cameraX - 300 || b.x > cameraX + canvas.width + 300 ||
                b.y < -300 || b.y > canvas.height + 300 ||
                b.trail.length > 200) {  // safety net
                bullets.splice(i, 1);
            }
        }

        // Global bullet cap - prevent memory bomb
        if (bullets.length > 300) {
            bullets.splice(0, bullets.length - 250);
        }
    }

    function generateStructures() {
        // Make structures spawn less frequently to reduce object count
        if (player.x > lastStructureDist + 600 + Math.random() * 400) {
            const type = Math.random() < 0.4 ? 'mosque' : 'building';
            const height = 150 + Math.random() * 200;
            const width = 100 + Math.random() * 150;
            const x = cameraX + canvas.width + 150;
            const y = groundY - height;
            platforms.push({ x, y, width, height, type });

            // Fewer platforms per building
            const numPlatforms = Math.floor(Math.random() * 2) + 1;
            for (let i = 0; i < numPlatforms; i++) {
                const pWidth = 50 + Math.random() * 80;
                const pX = x + Math.random() * (width - pWidth);
                const pY = y + (height / (numPlatforms + 1)) * (i + 1) - 10;
                platforms.push({ x: pX, y: pY, width: pWidth, height: 10, type: 'platform' });
            }

            lastStructureDist = player.x;
        }

        // Much more aggressive cleanup
        platforms = platforms.filter(p => p.x + p.width > cameraX - 400);
    }

    // In gameLoop, add this safety at the very beginning:
    function gameLoop() {
        if (frame % 300 === 0) {  // every ~5 seconds @60fps
            // Force garbage collection hint + log for debugging
            if (bullets.length > 200 || platforms.length > 80) {
                console.log("Cleaning up - bullets:", bullets.length, "platforms:", platforms.length);
            }
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        groundY = canvas.height - 120;

        if (gameState === 'playing') {
            updateGame();
        } else if (pointer.isDown) {
            resetGame();
        }

        drawBG();
        drawStructures();
        drawBullets();
        drawPowerups();
        enemies.forEach(drawEnemy);
        drawPlayer();
        drawUI();

        if (gameState === 'gameover') {
            drawGameOver();
        }

        frame++;
        requestAnimationFrame(gameLoop);
    }

    // ... rest of the code remains the same ...
</script>
